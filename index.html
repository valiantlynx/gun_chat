<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Gun Chat</title>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #login-form,
    #chat-form {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    #login-form {
      background-color: #f0f0f0;
    }

    #login-form input[type="text"],
    #login-form input[type="password"],
    #chat-input {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
    }

    #login-form input[type="submit"],
    #chat-button {
      background-color: #008CBA;
      color: #fff;
      padding: 10px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #login-form input[type="submit"]:hover,
    #chat-button:hover {
      background-color: #006B8F;
    }

    #chat {
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      padding: 10px;
    }

    .message {
      margin-bottom: 10px;
    }

    .username {
      font-weight: bold;
      margin-right: 10px;
    }

    .time {
      color: #777;
      margin-right: 10px;
    }

    .own-message {
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>
  <div id="login-form">
    <h1>Gun Chat</h1>
    <form>
      <input type="text" id="username-input" placeholder="Username" />
      <input type="password" id="password-input" placeholder="Password" />
      <input type="submit" id="login-button" value="Log In" />
    </form>
    <button id="register-button">Register</button>
  </div>

  <div id="chat-form" style="display: none;">
    <h1>Gun Chat</h1>
    <div id="chat"></div>
    <form>
      <input type="text" id="chat-input" placeholder="Type your message..." />
      <input type="button" id="send-button" value="Send" />
    </form>
    <button id="logout-button">Log Out</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script>
    const gun = Gun(['http://localhost:8765/gun', 'https://minfuel.com/gun']);
    let currentUser = null;
    let chatNode = null;

    function registerUser(event) {
      event.preventDefault();
      const username = document.getElementById('username-input').value.trim();
      const password = document.getElementById('password-input').value.trim();

      if (username === '' || password === '') {
        alert('Please enter a username and password');
        return;
      }

      gun.get('users').get(username).put({ username, password }, (ack) => {
        if (ack.err) {
          alert('Username already exists');
        } else {
          loginUser(username, password);
        }
      });
    }
    function loginUser(username, password) {
      gun.get('users').get(username).once((data, key) => {
        if (data && data.password === password) {
          currentUser = username;
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('chat-form').style.display = 'flex';
          document.getElementById('chat-input').focus();

          // Cache the logged-in user
          localStorage.setItem('currentUser', currentUser);
          localStorage.setItem('currentPassword', password);

          // Load chat history
          gun.get('messages').once((data, key) => {
            Object.values(data).forEach((message) => {
              addMessage(message);
            });

            // Scroll to the bottom of the chat
            document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
          });
        } else {
          alert('Incorrect username or password');
        }
      });
    }


    function logoutUser() {
      currentUser = null;
      gun.user().leave();
      document.getElementById('chat').innerHTML = '';
      document.getElementById('chat-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'flex';
    }

    function sendMessage(event) {
      event.preventDefault();
      const message = document.getElementById('chat-input').value.trim();
      if (message !== '') {
        const time = new Date().getTime();
        gun.get('messages').set({ username: currentUser, message, time });
        document.getElementById('chat-input').value = '';
      }
    }

    gun.on('auth', () => {
      const user = gun.user();
      if (user.is) {
        currentUser = user.is.alias;
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('chat-form').style.display = 'flex';
        document.getElementById('chat-input').focus();
      }
    });

    gun.get('messages').map().on((data, key) => {
      if (data.username && data.message && data.time) {
        const message = document.createElement('div');
        message.classList.add('message');
        if (data.username === currentUser) {
          message.classList.add('own-message');
        }

        const username = document.createElement('span');
        username.classList.add('username');
        username.textContent = data.username;

        const time = document.createElement('span');
        time.classList.add('time');
        time.textContent = new Date(data.time).toLocaleTimeString();

        const text = document.createElement('span');
        text.textContent = data.message;

        message.appendChild(username);
        message.appendChild(time);
        message.appendChild(text);

        document.getElementById('chat').appendChild(message);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
      }
    });

    document.getElementById('register-button').addEventListener('click', registerUser);
    document.getElementById('login-button').addEventListener('click', (event) => {
      event.preventDefault();
      const username = document.getElementById('username-input').value.trim();
      const password = document.getElementById('password-input').value.trim();

      if (username === '' || password === '') {
        alert('Please enter a username and password');
        return;
      }

      loginUser(username, password);
    });
    document.getElementById('logout-button').addEventListener('click', logoutUser);
    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        sendMessage(event);
      }
    });

  </script>
</body>

</html>